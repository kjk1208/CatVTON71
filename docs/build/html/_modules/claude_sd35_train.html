<!DOCTYPE html>

<html lang="ko" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>claude_sd35_train &#8212; CatVTON 1.0 문서</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=12dfc556" />
    <script src="../_static/documentation_options.js?v=25ffd669"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=e33e7ba0"></script>
    <link rel="index" title="색인" href="../genindex.html" />
    <link rel="search" title="검색" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>claude_sd35_train의 소스 코드</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># ================================================================</span>
<span class="c1"># SD3.5 CatVTON Training Script (Enhanced Version)</span>
<span class="c1"># ================================================================</span>
<span class="c1"># </span>
<span class="c1"># 이 스크립트는 Stable Diffusion 3.5를 기반으로 한 Virtual Try-On (VTON) 모델을 학습합니다.</span>
<span class="c1"># </span>
<span class="c1"># 주요 기능:</span>
<span class="c1"># 1. SD3.5 Transformer를 CatVTON 작업에 맞게 fine-tuning</span>
<span class="c1"># 2. FlowMatch 스케줄러를 사용한 안정적인 학습</span>
<span class="c1"># 3. Inpainting 방식의 의상 합성 학습</span>
<span class="c1"># 4. 실시간 프리뷰 생성으로 학습 진행 모니터링</span>
<span class="c1"># 5. 분산 학습 지원 (DDP)</span>
<span class="c1"># </span>
<span class="c1"># 아키텍처:</span>
<span class="c1"># - VAE: 이미지 ↔ latent 변환</span>
<span class="c1"># - Transformer: SD3.5 기반 denoising 모델</span>
<span class="c1"># - FlowMatch: 노이즈 스케줄링 및 샘플링</span>
<span class="c1"># - Inpainting: 마스크 기반 의상 영역 합성</span>
<span class="c1"># </span>
<span class="c1"># 학습 과정:</span>
<span class="c1"># 1. 사람 이미지 + 의상 이미지 + 마스크 → 배치 구성</span>
<span class="c1"># 2. VAE로 latent space 변환</span>
<span class="c1"># 3. 마스크 기반 inpainting 입력 구성</span>
<span class="c1"># 4. Transformer로 denoising 학습</span>
<span class="c1"># 5. 주기적으로 프리뷰 이미지 생성</span>
<span class="c1"># ================================================================</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">DistributedSampler</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.distributed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dist</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn.parallel</span><span class="w"> </span><span class="kn">import</span> <span class="n">DistributedDataParallel</span> <span class="k">as</span> <span class="n">DDP</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_image</span><span class="p">,</span> <span class="n">make_grid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.tensorboard</span><span class="w"> </span><span class="kn">import</span> <span class="n">SummaryWriter</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">yaml</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">matmul</span><span class="o">.</span><span class="n">allow_tf32</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">set_float32_matmul_precision</span><span class="p">(</span><span class="s2">&quot;high&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">diffusers</span><span class="w"> </span><span class="kn">import</span> <span class="n">StableDiffusion3Img2ImgPipeline</span> <span class="k">as</span> <span class="n">StableDiffusion3Pipeline</span>  <span class="c1"># VTON은 Img2Img가 더 적합</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">diffusers.models.transformers.transformer_sd3</span><span class="w"> </span><span class="kn">import</span> <span class="n">SD3Transformer2DModel</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">diffusers.schedulers</span><span class="w"> </span><span class="kn">import</span> <span class="n">FlowMatchEulerDiscreteScheduler</span> <span class="k">as</span> <span class="n">FM</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">diffusers.training_utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">compute_density_for_timestep_sampling</span><span class="p">,</span>
        <span class="n">compute_loss_weighting_for_sd3</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
        <span class="s2">&quot;This training script requires diffusers with SD3 support. &quot;</span>
        <span class="s2">&quot;Install/update: pip install -U &#39;diffusers&gt;=0.36.0&#39; &#39;transformers&gt;=4.43.0&#39; &#39;safetensors&gt;=0.4.3&#39;&quot;</span>
    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">huggingface_hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">snapshot_download</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">amp</span> <span class="k">as</span> <span class="n">torch_amp</span>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># Utils</span>
<span class="c1"># ------------------------------------------------------------</span>
<div class="viewcode-block" id="seed_everything">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.seed_everything">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">seed_everything</span><span class="p">(</span><span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span></div>


<div class="viewcode-block" id="from_uint8">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.from_uint8">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">from_uint8</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">size_hw</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">size_hw</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Image</span><span class="o">.</span><span class="n">BICUBIC</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="load_mask">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.load_mask">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_mask</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">size_hw</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">size_hw</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Image</span><span class="o">.</span><span class="n">NEAREST</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span></div>


<div class="viewcode-block" id="DotDict">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.DotDict">[문서]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DotDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="fm">__getattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span>
    <span class="fm">__setattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__setitem__</span>
    <span class="fm">__delattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__delitem__</span></div>


<span class="c1"># ---- DDP helpers ----</span>
<div class="viewcode-block" id="maybe_init_distributed">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.maybe_init_distributed">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">maybe_init_distributed</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;RANK&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;RANK&quot;</span><span class="p">])</span>
        <span class="n">world_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WORLD_SIZE&quot;</span><span class="p">])</span>
        <span class="n">local_rank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LOCAL_RANK&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">local_rank</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;nccl&quot;</span><span class="p">,</span> <span class="n">init_method</span><span class="o">=</span><span class="s2">&quot;env://&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">60</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;is_dist&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;world_size&quot;</span><span class="p">:</span> <span class="n">world_size</span><span class="p">,</span> <span class="s2">&quot;local_rank&quot;</span><span class="p">:</span> <span class="n">local_rank</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;is_dist&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;world_size&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;local_rank&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span></div>


<div class="viewcode-block" id="get_distributed_info">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.get_distributed_info">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_distributed_info</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span>
        <span class="n">world_size</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">()</span>
        <span class="n">local_rank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LOCAL_RANK&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;is_dist&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;world_size&quot;</span><span class="p">:</span> <span class="n">world_size</span><span class="p">,</span> <span class="s2">&quot;local_rank&quot;</span><span class="p">:</span> <span class="n">local_rank</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;is_dist&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;world_size&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;local_rank&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span></div>


<div class="viewcode-block" id="bcast_object">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.bcast_object">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bcast_object</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="p">]</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">broadcast_object_list</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">src</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="NoopWriter">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.NoopWriter">[문서]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NoopWriter</span><span class="p">:</span>
<div class="viewcode-block" id="NoopWriter.add_scalar">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.NoopWriter.add_scalar">[문서]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span> <span class="k">pass</span></div>

<div class="viewcode-block" id="NoopWriter.close">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.NoopWriter.close">[문서]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span></div>
</div>


<div class="viewcode-block" id="ddp_state_dict">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.ddp_state_dict">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ddp_state_dict</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">DDP</span><span class="p">)</span> <span class="k">else</span> <span class="n">m</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_debug_print_trainables</span><span class="p">(</span><span class="n">mod</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_items</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mod</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
    <span class="n">train</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mod</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[trainables/</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">] total=</span><span class="si">{</span><span class="n">total</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">M, trainable=</span><span class="si">{</span><span class="n">train</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">M&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_try_copy_running_script</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">script_path</span><span class="p">)</span>
            <span class="n">dst_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="n">dst_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[warn] failed to copy running script: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># Dataset</span>
<span class="c1"># ------------------------------------------------------------</span>
<div class="viewcode-block" id="PairListDataset">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.PairListDataset">[문서]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PairListDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<div class="viewcode-block" id="PairListDataset.__init__">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.PairListDataset.__init__">[문서]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">size_hw</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
                 <span class="n">mask_based</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">invert_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">list_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jsonl&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">list_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">list_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">list_file</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">list_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;person&quot;</span><span class="p">:</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;garment&quot;</span><span class="p">:</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;person&quot;</span><span class="p">:</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;garment&quot;</span><span class="p">:</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">size_hw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_based</span> <span class="o">=</span> <span class="n">mask_based</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invert_mask</span> <span class="o">=</span> <span class="n">invert_mask</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;person&quot;</span><span class="p">])</span>
        <span class="n">garment</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;garment&quot;</span><span class="p">])</span>

        <span class="n">x_p</span> <span class="o">=</span> <span class="n">from_uint8</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">))</span>
        <span class="n">x_g</span> <span class="o">=</span> <span class="n">from_uint8</span><span class="p">(</span><span class="n">garment</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_based</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">,</span> <span class="s2">&quot;mask_based=True requires mask path per line&quot;</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">load_mask</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">],</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invert_mask</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">m</span>
            <span class="n">x_p_in</span> <span class="o">=</span> <span class="n">x_p</span> <span class="o">*</span> <span class="n">m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x_p</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">x_p_in</span> <span class="o">=</span> <span class="n">x_p</span>

        <span class="n">x_concat_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x_p_in</span><span class="p">,</span> <span class="n">x_g</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">x_concat_gt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x_p</span><span class="p">,</span>   <span class="n">x_g</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">m_concat</span>    <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">m</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;x_concat_in&quot;</span><span class="p">:</span> <span class="n">x_concat_in</span><span class="p">,</span> <span class="s2">&quot;x_concat_gt&quot;</span><span class="p">:</span> <span class="n">x_concat_gt</span><span class="p">,</span> <span class="s2">&quot;m_concat&quot;</span><span class="p">:</span> <span class="n">m_concat</span><span class="p">}</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># SD3.5 helpers (Fixed Version 2)</span>
<span class="c1"># ------------------------------------------------------------</span>
<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_latent_sd3</span><span class="p">(</span><span class="n">vae</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;수정된 VAE 인코딩 - 스케일링 팩터 정확히 적용&quot;&quot;&quot;</span>
    <span class="n">vdtype</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">vae</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">posterior</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">vdtype</span><span class="p">))</span><span class="o">.</span><span class="n">latent_dist</span>
    <span class="k">if</span> <span class="n">sample</span><span class="p">:</span>
        <span class="n">latents</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">latents</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span>
    
    <span class="c1"># SD3.5 정확한 스케일링 적용</span>
    <span class="n">scaling_factor</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;scaling_factor&#39;</span><span class="p">,</span> <span class="mf">1.5305</span><span class="p">)</span>
    <span class="n">shift_factor</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;shift_factor&#39;</span><span class="p">,</span> <span class="mf">0.0609</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">latents</span> <span class="o">-</span> <span class="n">shift_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">scaling_factor</span>

<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_latent_sd3</span><span class="p">(</span><span class="n">vae</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;수정된 VAE 디코딩 - 스케일링 팩터 정확히 역적용&quot;&quot;&quot;</span>
    <span class="n">vdtype</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">vae</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">vdtype</span><span class="p">)</span>
    
    <span class="c1"># SD3.5 정확한 스케일링 역적용</span>
    <span class="n">scaling_factor</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;scaling_factor&#39;</span><span class="p">,</span> <span class="mf">1.5305</span><span class="p">)</span>
    <span class="n">shift_factor</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;shift_factor&#39;</span><span class="p">,</span> <span class="mf">0.0609</span><span class="p">)</span>
    
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">/</span> <span class="n">scaling_factor</span> <span class="o">+</span> <span class="n">shift_factor</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span>
    <span class="k">return</span> <span class="n">img</span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># Enhanced FlowMatch Scheduler</span>
<span class="c1"># ------------------------------------------------------------</span>
<div class="viewcode-block" id="create_enhanced_fm_scheduler">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.create_enhanced_fm_scheduler">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_enhanced_fm_scheduler</span><span class="p">(</span><span class="n">base_scheduler_config</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">transformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;향상된 FlowMatch 스케줄러 생성 (더 안정적인 노이즈 스케줄링)&quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">base_scheduler_config</span><span class="p">)</span>
    
    <span class="c1"># SD3.5 안정화 설정</span>
    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;num_train_timesteps&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="s2">&quot;shift&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>  <span class="c1"># SD3.5 기본값 (더 부드러운 노이즈 스케줄)</span>
        <span class="s2">&quot;use_dynamic_shifting&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;base_shift&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s2">&quot;max_shift&quot;</span><span class="p">:</span> <span class="mf">1.15</span><span class="p">,</span>
        <span class="s2">&quot;base_image_seq_len&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
        <span class="s2">&quot;max_image_seq_len&quot;</span><span class="p">:</span> <span class="mi">4096</span>
    <span class="p">})</span>
    
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">FM</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    
    <span class="c1"># 정확한 VAE 스케일 팩터</span>
    <span class="n">vae_scale_factor</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">patch_size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transformer</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;patch_size&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># 이미지 토큰 길이 계산 (2W 때문에 가로가 2배)</span>
    <span class="n">h_tokens</span> <span class="o">=</span> <span class="n">height</span> <span class="o">//</span> <span class="n">vae_scale_factor</span> <span class="o">//</span> <span class="n">patch_size</span>
    <span class="n">w_tokens</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span> <span class="o">//</span> <span class="n">vae_scale_factor</span> <span class="o">//</span> <span class="n">patch_size</span>
    <span class="n">image_seq_len</span> <span class="o">=</span> <span class="n">h_tokens</span> <span class="o">*</span> <span class="n">w_tokens</span>
    
    <span class="c1"># Dynamic shifting 계산</span>
    <span class="n">base_len</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;base_image_seq_len&quot;</span><span class="p">]</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_image_seq_len&quot;</span><span class="p">]</span>
    <span class="n">base_s</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;base_shift&quot;</span><span class="p">]</span>
    <span class="n">max_s</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_shift&quot;</span><span class="p">]</span>
    
    <span class="n">mu</span> <span class="o">=</span> <span class="n">base_s</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_s</span> <span class="o">-</span> <span class="n">base_s</span><span class="p">)</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">image_seq_len</span> <span class="o">-</span> <span class="n">base_len</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="n">base_len</span><span class="p">)))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">base_s</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_s</span><span class="p">,</span> <span class="n">mu</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">mu</span></div>


<div class="viewcode-block" id="setup_enhanced_timesteps">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.setup_enhanced_timesteps">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_enhanced_timesteps</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;개선된 timesteps 설정&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scheduler</span><span class="o">.</span><span class="n">set_timesteps</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scheduler</span><span class="o">.</span><span class="n">set_timesteps</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
        <span class="c1"># mu를 지원하지 않는 경우 기본 설정 사용</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="n">set_timesteps</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    
    <span class="c1"># timesteps 정규화 및 검증</span>
    <span class="n">timesteps</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">timesteps</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    
    <span class="c1"># 내림차순 정렬 확인</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timesteps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">timesteps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">timesteps</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">timesteps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># 마지막이 0에 가깝지 않으면 추가</span>
    <span class="k">if</span> <span class="n">timesteps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">:</span>
        <span class="n">timesteps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">timesteps</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
    
    <span class="n">scheduler</span><span class="o">.</span><span class="n">timesteps</span> <span class="o">=</span> <span class="n">timesteps</span>
    <span class="k">return</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">timesteps</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># Freezing</span>
<span class="c1"># ------------------------------------------------------------</span>
<div class="viewcode-block" id="freeze_all_but_self_attn_qkv">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.freeze_all_but_self_attn_qkv">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">freeze_all_but_self_attn_qkv</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="n">open_to_add_out</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">open_io</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                 <span class="n">open_ffn_blocks</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">open_block_norms</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># 모든 파라미터 동결</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">transformer</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Self-attention Q/K/V/Out만 학습 가능하게</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">transformer</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.attn&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;to_q&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;to_q&quot;</span><span class="p">,</span> <span class="s2">&quot;to_k&quot;</span><span class="p">,</span> <span class="s2">&quot;to_v&quot;</span><span class="p">,</span> <span class="s2">&quot;to_out&quot;</span><span class="p">]:</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Cross-attention은 동결 유지</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">transformer</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.attn&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;add_k_proj&quot;</span><span class="p">,</span> <span class="s2">&quot;add_v_proj&quot;</span><span class="p">,</span> <span class="s2">&quot;add_q_proj&quot;</span><span class="p">]:</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="n">sub</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;to_add_out&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">open_to_add_out</span><span class="p">)</span>

    <span class="c1"># I/O 어댑터</span>
    <span class="k">if</span> <span class="n">open_io</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="s2">&quot;pos_embed&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transformer</span><span class="o">.</span><span class="n">pos_embed</span><span class="p">,</span> <span class="s2">&quot;proj&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">transformer</span><span class="o">.</span><span class="n">pos_embed</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">transformer</span><span class="o">.</span><span class="n">norm_out</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">transformer</span><span class="o">.</span><span class="n">proj_out</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># FFN 블록</span>
    <span class="k">if</span> <span class="n">open_ffn_blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transformer</span><span class="p">,</span> <span class="s2">&quot;transformer_blocks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">open_ffn_blocks</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">):</span>
                    <span class="n">blk</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ff&quot;</span><span class="p">,</span> <span class="s2">&quot;ff_context&quot;</span><span class="p">]:</span>
                        <span class="n">sub</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">blk</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span> 
                                <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">open_block_norms</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;norm2&quot;</span><span class="p">,</span> <span class="s2">&quot;norm2_context&quot;</span><span class="p">]:</span>
                            <span class="n">sub</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">blk</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span> 
                                    <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">trainable</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">transformer</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">trainable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No params unfrozen; check patterns.&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">trainable</span></div>


<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># Enhanced Trainer</span>
<span class="c1"># ------------------------------------------------------------</span>
<div class="viewcode-block" id="EnhancedCatVTON_SD3_Trainer">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.EnhancedCatVTON_SD3_Trainer">[문서]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EnhancedCatVTON_SD3_Trainer</span><span class="p">:</span>
<div class="viewcode-block" id="EnhancedCatVTON_SD3_Trainer.__init__">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.EnhancedCatVTON_SD3_Trainer.__init__">[문서]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">DotDict</span><span class="p">,</span> <span class="n">run_dirs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">cfg_yaml_to_save</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>

        <span class="n">dinfo</span> <span class="o">=</span> <span class="n">get_distributed_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_dist</span> <span class="o">=</span> <span class="n">dinfo</span><span class="p">[</span><span class="s2">&quot;is_dist&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">dinfo</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world_size</span> <span class="o">=</span> <span class="n">dinfo</span><span class="p">[</span><span class="s2">&quot;world_size&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">=</span> <span class="n">dinfo</span><span class="p">[</span><span class="s2">&quot;local_rank&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">seed_everything</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">seed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cuda:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">local_rank</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="n">mp2dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fp16&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="s2">&quot;fp32&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s2">&quot;bf16&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">mp2dtype</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">mixed_precision</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span>

        <span class="c1"># 디렉토리 및 로깅 설정</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span> <span class="o">=</span> <span class="n">run_dirs</span><span class="p">[</span><span class="s2">&quot;run_dir&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_dir</span> <span class="o">=</span> <span class="n">run_dirs</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="n">run_dirs</span><span class="p">[</span><span class="s2">&quot;models&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb_dir</span> <span class="o">=</span> <span class="n">run_dirs</span><span class="p">[</span><span class="s2">&quot;tb&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">img_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_dir</span><span class="p">]:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;catvton_</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;log.txt&quot;</span><span class="p">)</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tb</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tb_dir</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span> <span class="k">else</span> <span class="n">NoopWriter</span><span class="p">()</span>

        <span class="c1"># 설정 저장</span>
        <span class="k">if</span> <span class="n">cfg_yaml_to_save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">yaml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">cfg_yaml_to_save</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># HF 토큰 처리</span>
        <span class="n">env_token</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HUGGINGFACE_TOKEN&quot;</span><span class="p">)</span>
                     <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HUGGINGFACE_HUB_TOKEN&quot;</span><span class="p">)</span>
                     <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HF_TOKEN&quot;</span><span class="p">))</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hf_token</span> <span class="ow">or</span> <span class="n">env_token</span>

        <span class="c1"># SD3.5 모델 로드</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="n">local_dir</span> <span class="o">=</span> <span class="n">snapshot_download</span><span class="p">(</span>
                <span class="n">repo_id</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">sd3_model</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">resume_download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_files_only</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dist</span><span class="p">:</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="n">local_dir</span> <span class="o">=</span> <span class="n">snapshot_download</span><span class="p">(</span>
                <span class="n">repo_id</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">sd3_model</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">resume_download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">local_files_only</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="c1"># 파이프라인 로드</span>
        <span class="n">pipe</span> <span class="o">=</span> <span class="n">StableDiffusion3Pipeline</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="n">local_dir</span><span class="p">,</span> <span class="n">torch_dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">local_files_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_safetensors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vae</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">vae</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">:</span> <span class="n">SD3Transformer2DModel</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">transformer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encode_prompt</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">encode_prompt</span>
        
        <span class="c1"># VAE 스케일링 팩터 확인</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;scaling_factor&#39;</span><span class="p">,</span> <span class="mf">1.5305</span><span class="p">)</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;shift_factor&#39;</span><span class="p">,</span> <span class="mf">0.0609</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VAE scaling_factor=</span><span class="si">{</span><span class="n">sf</span><span class="si">}</span><span class="s2">, shift_factor=</span><span class="si">{</span><span class="n">shift</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># 디버깅: VAE 설정 전체 출력</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VAE config: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># 디버깅: 테스트 인코딩/디코딩 체크</span>
            <span class="n">test_img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">test_lat</span> <span class="o">=</span> <span class="n">to_latent_sd3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">,</span> <span class="n">test_img</span><span class="p">)</span>
                <span class="n">test_rec</span> <span class="o">=</span> <span class="n">from_latent_sd3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">,</span> <span class="n">test_lat</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test encode/decode - input range: [</span><span class="si">{</span><span class="n">test_img</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">test_img</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test encode/decode - latent range: [</span><span class="si">{</span><span class="n">test_lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">test_lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test encode/decode - output range: [</span><span class="si">{</span><span class="n">test_rec</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">test_rec</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="c1"># 향상된 스케줄러 생성</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_scheduler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mu</span> <span class="o">=</span> <span class="n">create_enhanced_fm_scheduler</span><span class="p">(</span>
            <span class="n">pipe</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">size_h</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">size_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infer_scheduler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_mu</span> <span class="o">=</span> <span class="n">create_enhanced_fm_scheduler</span><span class="p">(</span>
            <span class="n">pipe</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">size_h</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">size_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enhanced FlowMatch scheduler with mu_train=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">train_mu</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded SD3.5 model: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">sd3_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 메모리 최적화</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">enable_gradient_checkpointing</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[mem] gradient checkpointing ON&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[mem] gradient checkpointing not available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 파라미터 동결</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">transformer_blocks</span><span class="p">)</span>
        <span class="n">mid_ffn_blocks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">//</span><span class="mi">3</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">//</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>

        <span class="n">trainable_tf</span> <span class="o">=</span> <span class="n">freeze_all_but_self_attn_qkv</span><span class="p">(</span>
            <span class="n">transformer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">,</span> 
            <span class="n">open_io</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
            <span class="n">open_ffn_blocks</span><span class="o">=</span><span class="n">mid_ffn_blocks</span><span class="p">,</span> 
            <span class="n">open_block_norms</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="c1"># 안정성을 위해 trainable 파라미터를 fp32로 유지</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trainable params (transformer only)=</span><span class="si">{</span><span class="n">trainable_tf</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">M&quot;</span><span class="p">)</span>
            <span class="n">_debug_print_trainables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">,</span> <span class="s2">&quot;after_freeze_before_ddp&quot;</span><span class="p">)</span>

        <span class="c1"># 데이터셋</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">PairListDataset</span><span class="p">(</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">list_file</span><span class="p">,</span> <span class="n">size_hw</span><span class="o">=</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">size_h</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">size_w</span><span class="p">),</span>
            <span class="n">mask_based</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">mask_based</span><span class="p">,</span> <span class="n">invert_mask</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">invert_mask</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="n">DistributedSampler</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">num_replicas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">world_size</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">sampler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span> 
            <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
            <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset len=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> batch_size(per-rank)=</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Enhanced mask semantics: Mi=1 KEEP, Mi=0 HOLE&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">//</span> <span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span> <span class="o">//</span> <span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># AMP 스케일러</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_scaler</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[amp] dtype=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">, use_scaler=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">use_scaler</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># DDP 래핑</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">DDP</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">,</span> 
            <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_rank</span><span class="p">],</span> 
            <span class="n">output_device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_rank</span><span class="p">,</span>
            <span class="n">broadcast_buffers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">find_unused_parameters</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># 향상된 옵티마이저 설정</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_enhanced_optimizer</span><span class="p">()</span>

        <span class="c1"># 체크포인트 복원</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">resume_path</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">resume_ckpt</span> <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">default_resume_ckpt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resume_from_ckpt_if_needed</span><span class="p">(</span><span class="n">resume_path</span><span class="p">)</span>

        <span class="c1"># 초기화</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_loss_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_loss_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preview_gen</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">preview_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_keep_logged</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># 스케일러</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">torch_amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_scaler</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_enhanced_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;향상된 옵티마이저 설정 - 파라미터 그룹별 차등 학습률&quot;&quot;&quot;</span>
        <span class="n">qkv_params</span><span class="p">,</span> <span class="n">io_params</span><span class="p">,</span> <span class="n">ffn_params</span><span class="p">,</span> <span class="n">other_params</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.attn.to_q&quot;</span><span class="p">,</span> <span class="s2">&quot;.attn.to_k&quot;</span><span class="p">,</span> <span class="s2">&quot;.attn.to_v&quot;</span><span class="p">,</span> <span class="s2">&quot;.attn.to_out&quot;</span><span class="p">]):</span>
                <span class="n">qkv_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pos_embed.proj&quot;</span><span class="p">,</span> <span class="s2">&quot;norm_out&quot;</span><span class="p">,</span> <span class="s2">&quot;proj_out&quot;</span><span class="p">]):</span>
                <span class="n">io_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.ff.&quot;</span><span class="p">,</span> <span class="s2">&quot;.ff_context.&quot;</span><span class="p">]):</span>
                <span class="n">ffn_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">other_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="n">param_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">base_lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">lr</span>
        
        <span class="k">if</span> <span class="n">qkv_params</span><span class="p">:</span>
            <span class="n">param_groups</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">qkv_params</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">base_lr</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;qkv&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">io_params</span><span class="p">:</span>
            <span class="n">param_groups</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">io_params</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">base_lr</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;io&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">ffn_params</span><span class="p">:</span>
            <span class="n">param_groups</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">ffn_params</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">base_lr</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ffn&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">other_params</span><span class="p">:</span>
            <span class="n">param_groups</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">other_params</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">base_lr</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;other&quot;</span><span class="p">})</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_groups</span><span class="p">:</span>
            <span class="n">tf_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">]</span>
            <span class="n">param_groups</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">tf_params</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="n">base_lr</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">}]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span>
            <span class="n">param_groups</span><span class="p">,</span>
            <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>  <span class="c1"># 더 안정적인 베타값</span>
            <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> 
            <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span>  <span class="c1"># 약간의 정규화</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_encode_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bsz</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;개선된 프롬프트 인코딩&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;disable_text&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_uncond_pe&quot;</span><span class="p">):</span>
                <span class="n">pe</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ppe</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_prompt</span><span class="p">(</span>
                    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">prompt_2</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">prompt_3</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">num_images_per_prompt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">do_classifier_free_guidance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_uncond_pe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_uncond_ppe</span> <span class="o">=</span> <span class="n">ppe</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_uncond_pe</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_uncond_ppe</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">())</span>

        <span class="c1"># 더 구체적인 프롬프트</span>
        <span class="n">fixed_txt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span>
            <span class="s2">&quot;fixed_prompt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;high quality, photorealistic, detailed clothing texture, natural lighting, sharp focus&quot;</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_fixed_pe&quot;</span><span class="p">):</span>
            <span class="n">pe</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ppe</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_prompt</span><span class="p">(</span>
                <span class="n">prompt</span><span class="o">=</span><span class="n">fixed_txt</span><span class="p">,</span>
                <span class="n">prompt_2</span><span class="o">=</span><span class="n">fixed_txt</span><span class="p">,</span>
                <span class="n">prompt_3</span><span class="o">=</span><span class="n">fixed_txt</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="n">num_images_per_prompt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">do_classifier_free_guidance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_pe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_ppe</span> <span class="o">=</span> <span class="n">ppe</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fixed_pe</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_ppe</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_denorm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_enhanced_noise_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">timestep</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;스케줄러의 scale_model_input을 우선 사용, 없으면 안전한 fallback&quot;&quot;&quot;</span>
        <span class="c1"># 가능한 경우 스케줄러 API 사용</span>
        <span class="n">scheduler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_active_scheduler_for_scale&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="s2">&quot;scale_model_input&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">scale_model_input</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">timestep</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Fallback: 이전의 보수적 스케일링(알파 계산)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">timestep</span><span class="p">):</span>
            <span class="n">timestep</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">timestep</span> <span class="o">=</span> <span class="n">timestep</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timestep</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">timestep</span> <span class="o">=</span> <span class="n">timestep</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">timestep</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">x_f32</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">alpha_t</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x_f32</span> <span class="o">*</span> <span class="n">alpha_t</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_noise_with_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">clean_latents</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">timestep</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;스케줄러의 add_noise/scale_noise를 우선 사용하고, 없으면 안전한 fallback.&quot;&quot;&quot;</span>
        <span class="c1"># timestep 정형화</span>
        <span class="n">timestep</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">clean_latents</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timestep</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">timestep</span> <span class="o">=</span> <span class="n">timestep</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timestep</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">clean_latents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">timestep</span> <span class="o">=</span> <span class="n">timestep</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">clean_latents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># 1) diffusers API가 있으면 사용</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="s2">&quot;add_noise&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">add_noise</span><span class="p">(</span><span class="n">clean_latents</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">timestep</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        
        <span class="c1"># FlowMatch의 scale_noise 사용 (올바른 방법)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="s2">&quot;scale_noise&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># FlowMatch: scale_noise는 noise를 스케일링만 함</span>
                <span class="n">scaled_noise</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">scale_noise</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">timestep</span><span class="p">)</span>
                <span class="c1"># FlowMatch 공식: x_t = x_0 + scaled_noise</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">clean_latents</span> <span class="o">+</span> <span class="n">scaled_noise</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">clean_latents</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># 2) Fallback: 선형 혼합(정규화 t)</span>
        <span class="n">t_normalized</span> <span class="o">=</span> <span class="n">timestep</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="n">t_normalized</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">t_normalized</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">t_normalized</span><span class="p">)</span> <span class="o">*</span> <span class="n">clean_latents</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">+</span> <span class="n">t_normalized</span> <span class="o">*</span> <span class="n">noise</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">clean_latents</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_enhanced_preview_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_latents</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
                                <span class="n">pixels_for_keep</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                                <span class="n">shared_noise</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">start_idx_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;향상된 프리뷰 샘플링 - 더 안정적인 인페인팅&quot;&quot;&quot;</span>
        <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">size_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">size_w</span>
        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>

        <span class="c1"># 마스크를 latent 해상도로 변환</span>
        <span class="n">Mi</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
            <span class="n">m</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">H</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">W</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        
        <span class="n">B</span> <span class="o">=</span> <span class="n">start_latents</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 스케줄러 설정</span>
        <span class="n">scheduler</span><span class="p">,</span> <span class="n">timesteps</span> <span class="o">=</span> <span class="n">setup_enhanced_timesteps</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">infer_scheduler</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_mu</span>
        <span class="p">)</span>
        <span class="c1"># 모델 입력 스케일링 시 사용할 활성 스케줄러 지정</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_scheduler_for_scale</span> <span class="o">=</span> <span class="n">scheduler</span>

        <span class="c1"># 시작 인덱스 결정</span>
        <span class="k">if</span> <span class="n">start_idx_override</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">preview_strength</span><span class="p">)))</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timesteps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="n">N</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_idx_override</span><span class="p">)</span>

        <span class="n">timesteps_sub</span> <span class="o">=</span> <span class="n">timesteps</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">timesteps_sub</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">:</span>
            <span class="n">timesteps_sub</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">timesteps_sub</span><span class="p">,</span> <span class="n">timesteps_sub</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>

        <span class="c1"># 공유 노이즈 생성</span>
        <span class="k">if</span> <span class="n">shared_noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shared_noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">start_latents</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">start_latents</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> 
                                          <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_preview_gen</span><span class="p">)</span>

        <span class="c1"># 초기 노이즈 상태</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">timesteps_sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">start_noisy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_noise_with_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">start_latents</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">shared_noise</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>
        
        <span class="c1"># 인페인팅 초기화: 학습과 동일한 방식 사용</span>
        <span class="c1"># KEEP 영역은 입력 기반, HOLE 영역은 타겟 기반 (학습과 일치)</span>
        <span class="n">z0_noisy_t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_noise_with_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">start_latents</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">shared_noise</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">Mi</span> <span class="o">*</span> <span class="n">start_noisy</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Mi</span><span class="p">)</span> <span class="o">*</span> <span class="n">z0_noisy_t0</span>

        <span class="c1"># 프롬프트 임베딩</span>
        <span class="n">prompt_embeds</span><span class="p">,</span> <span class="n">pooled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_prompts</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">module</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">,</span> <span class="n">DDP</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span>

        <span class="n">was_train</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">training</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timesteps_sub</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">t_curr</span> <span class="o">=</span> <span class="n">timesteps_sub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">t_next</span> <span class="o">=</span> <span class="n">timesteps_sub</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                
                <span class="c1"># dt 먼저 계산</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">t_next</span> <span class="o">-</span> <span class="n">t_curr</span>
                
                <span class="n">t_batch</span> <span class="o">=</span> <span class="n">t_curr</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                
                <span class="c1"># 모델 입력 스케일링</span>
                <span class="n">z_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhanced_noise_schedule</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">)</span>
                
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;cuda&#39;</span><span class="p">)):</span>
                    <span class="n">raw_model_output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span>
                        <span class="n">hidden_states</span><span class="o">=</span><span class="n">z_scaled</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span>
                        <span class="n">timestep</span><span class="o">=</span><span class="n">t_batch</span><span class="p">,</span>
                        <span class="n">encoder_hidden_states</span><span class="o">=</span><span class="n">prompt_embeds</span><span class="p">,</span>
                        <span class="n">pooled_projections</span><span class="o">=</span><span class="n">pooled</span><span class="p">,</span>
                        <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

                <span class="c1"># 학습과 동일한 공식 사용</span>
                <span class="n">pred_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_scheduler</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;prediction_type&quot;</span><span class="p">,</span> <span class="s2">&quot;epsilon&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s2">&quot;epsilon&quot;</span><span class="p">:</span>
                    <span class="c1"># epsilon prediction: z_0 = z_t - σ * ε (학습과 동일)</span>
                    <span class="n">sigma_curr</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_curr</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>  <span class="c1"># 정규화된 timestep</span>
                    <span class="n">x0_pred</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">sigma_curr</span> <span class="o">*</span> <span class="n">raw_model_output</span>
                    <span class="n">model_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0_pred</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>  <span class="c1"># velocity for Euler</span>
                <span class="k">elif</span> <span class="n">pred_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
                    <span class="c1"># direct x0 prediction</span>
                    <span class="n">x0_pred</span> <span class="o">=</span> <span class="n">raw_model_output</span>
                    <span class="n">model_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0_pred</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>  <span class="c1"># velocity for Euler</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;v_prediction not supported, got </span><span class="si">{</span><span class="n">pred_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Euler 스텝</span>
                <span class="n">z_next</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">model_output</span>
                
                <span class="c1"># CatVTON 방식: 재합성 없이 전체 이미지 생성</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;remove_inpainting&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="c1"># 기존 인페인팅 재합성 (호환성)</span>
                    <span class="k">if</span> <span class="n">t_next</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">:</span>
                        <span class="n">Xi_noisy_next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_noise_with_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">start_latents</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">shared_noise</span><span class="p">,</span> <span class="n">t_next</span><span class="p">)</span>
                        <span class="n">z0_noisy_next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_noise_with_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">start_latents</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">shared_noise</span><span class="p">,</span> <span class="n">t_next</span><span class="p">)</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="n">Mi</span> <span class="o">*</span> <span class="n">Xi_noisy_next</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Mi</span><span class="p">)</span> <span class="o">*</span> <span class="n">z_next</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="n">Mi</span> <span class="o">*</span> <span class="n">start_latents</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Mi</span><span class="p">)</span> <span class="o">*</span> <span class="n">z_next</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># CatVTON: 재합성 없이 순수 생성 결과 사용</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">z_next</span>

            <span class="c1"># VAE 디코드 및 최종 합성</span>
            <span class="n">x_hat</span> <span class="o">=</span> <span class="n">from_latent_sd3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">,</span> <span class="n">z</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
            
            <span class="c1"># 학습 초기에는 더 관대한 clamp (자연스러운 색상 분포)</span>
            <span class="c1"># 하지만 여전히 극단적인 saturation은 방지</span>
            <span class="n">x_hat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">x_hat</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
            
            <span class="c1"># CatVTON 방식: GT 복사 없이 전체 이미지 출력</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;remove_inpainting&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="c1"># 전체 생성된 이미지 사용 (GT 복사 없음)</span>
                <span class="n">x_final</span> <span class="o">=</span> <span class="n">x_hat</span>
                
                <span class="c1"># 디버깅</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CatVTON debug - full image range: [</span><span class="si">{</span><span class="n">x_hat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">x_hat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                    
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 기존 inpainting 방식 (호환성)</span>
                <span class="n">K3_keep</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">x_final</span> <span class="o">=</span> <span class="n">K3_keep</span> <span class="o">*</span> <span class="n">pixels_for_keep</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">K3_keep</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_hat</span>
                
                <span class="c1"># 디버깅: saturation 체크</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inpaint debug - x_hat range: [</span><span class="si">{</span><span class="n">x_hat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">x_hat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inpaint debug - x_final range: [</span><span class="si">{</span><span class="n">x_final</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">x_final</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">x_final</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">was_train</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            
            <span class="c1"># 프리뷰 샘플링 중간 텐서들 정리</span>
            <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">z</span>
            <span class="k">if</span> <span class="s1">&#39;z_scaled&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">z_scaled</span>
            <span class="k">if</span> <span class="s1">&#39;model_output&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">model_output</span>
            <span class="k">if</span> <span class="s1">&#39;z_next&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">z_next</span>
            <span class="k">if</span> <span class="s1">&#39;x_hat&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">x_hat</span>
            <span class="k">if</span> <span class="s1">&#39;x_final&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">x_final</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_save_enhanced_preview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;향상된 프리뷰 저장 - 디버깅 추가&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping preview: not main process&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting preview generation at step </span><span class="si">{</span><span class="n">global_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preview_rows&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">max_rows</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preview rows: </span><span class="si">{</span><span class="n">rows</span><span class="si">}</span><span class="s2">, batch sizes: </span><span class="si">{</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">batch</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">x_in</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;x_concat_in&quot;</span><span class="p">][:</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">x_gt</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;x_concat_gt&quot;</span><span class="p">][:</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;m_concat&quot;</span><span class="p">][:</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tensors moved to device. Shapes: x_in=</span><span class="si">{</span><span class="n">x_in</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, x_gt=</span><span class="si">{</span><span class="n">x_gt</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, m=</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x_in</span><span class="p">,</span> <span class="n">x_gt</span><span class="p">,</span> <span class="n">m</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Empty tensors detected, skipping preview&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># 마스크 통계 로깅 (한 번만)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_keep_logged</span><span class="p">:</span>
                <span class="n">keep_ratio</span> <span class="o">=</span> <span class="n">m</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">hole_ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">keep_ratio</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[mask] KEEP ratio=</span><span class="si">{</span><span class="n">keep_ratio</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, HOLE ratio=</span><span class="si">{</span><span class="n">hole_ratio</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mask_keep_logged</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">num_steps</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">preview_infer_steps</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preview inference steps: </span><span class="si">{</span><span class="n">num_steps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># VAE 인코딩</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting VAE encoding...&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">Xi_lat</span> <span class="o">=</span> <span class="n">to_latent_sd3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">,</span> <span class="n">x_in</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_preview_gen</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
                <span class="n">z0_lat</span> <span class="o">=</span> <span class="n">to_latent_sd3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">,</span> <span class="n">x_gt</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_preview_gen</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VAE encoding done. Latent shapes: Xi_lat=</span><span class="si">{</span><span class="n">Xi_lat</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, z0_lat=</span><span class="si">{</span><span class="n">z0_lat</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">shared_noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">Xi_lat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">Xi_lat</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> 
                                          <span class="n">device</span><span class="o">=</span><span class="n">Xi_lat</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_preview_gen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shared noise generated: </span><span class="si">{</span><span class="n">shared_noise</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># 다양한 강도로 프리뷰 생성</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">preview_strength</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating preview from input with strength </span><span class="si">{</span><span class="n">strength</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">preview_from_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhanced_preview_sample</span><span class="p">(</span>
                <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
                <span class="n">start_latents</span><span class="o">=</span><span class="n">Xi_lat</span><span class="p">,</span>
                <span class="n">pixels_for_keep</span><span class="o">=</span><span class="n">x_in</span><span class="p">,</span>
                <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
                <span class="n">shared_noise</span><span class="o">=</span><span class="n">shared_noise</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preview from input generated: </span><span class="si">{</span><span class="n">preview_from_input</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating preview from GT&quot;</span><span class="p">)</span>
            <span class="n">preview_from_gt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhanced_preview_sample</span><span class="p">(</span>
                <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
                <span class="n">start_latents</span><span class="o">=</span><span class="n">z0_lat</span><span class="p">,</span>
                <span class="n">pixels_for_keep</span><span class="o">=</span><span class="n">x_gt</span><span class="p">,</span>
                <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
                <span class="n">shared_noise</span><span class="o">=</span><span class="n">shared_noise</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preview from GT generated: </span><span class="si">{</span><span class="n">preview_from_gt</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># 초기 노이즈 상태 시각화</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating noise visualization&quot;</span><span class="p">)</span>
            <span class="n">scheduler</span><span class="p">,</span> <span class="n">timesteps</span> <span class="o">=</span> <span class="n">setup_enhanced_timesteps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infer_scheduler</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_mu</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timesteps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">strength</span><span class="p">)</span> <span class="o">*</span> <span class="n">N</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">timesteps</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span>
            
            <span class="n">Mi_lat</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="n">m</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">size_h</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">size_w</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span><span class="p">),</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
            
            <span class="n">Xi_noisy0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_noise_with_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">Xi_lat</span><span class="p">,</span> <span class="n">shared_noise</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>
            <span class="c1"># HOLE 시각화는 순수 스케줄러 스케일 노이즈 사용</span>
            <span class="n">pure_noisy0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_noise_with_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Xi_lat</span><span class="p">),</span> <span class="n">shared_noise</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>
            <span class="n">z_init_vis</span> <span class="o">=</span> <span class="n">Mi_lat</span> <span class="o">*</span> <span class="n">Xi_noisy0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Mi_lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">pure_noisy0</span>
            <span class="n">xi_noisy_img</span> <span class="o">=</span> <span class="n">from_latent_sd3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">,</span> <span class="n">z_init_vis</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
            
            <span class="c1"># 노이즈 시각화도 관대한 clamp 적용</span>
            <span class="n">xi_noisy_img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">xi_noisy_img</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
            <span class="n">xi_noisy_img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">xi_noisy_img</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Noise visualization generated: </span><span class="si">{</span><span class="n">xi_noisy_img</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># 시각화 구성요소 준비</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Hh</span><span class="p">,</span> <span class="n">WW</span> <span class="o">=</span> <span class="n">x_gt</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">Ww</span> <span class="o">=</span> <span class="n">WW</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">person</span> <span class="o">=</span> <span class="n">x_gt</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">Ww</span><span class="p">]</span>
            <span class="n">garment</span> <span class="o">=</span> <span class="n">x_gt</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">Ww</span><span class="p">:]</span>
            <span class="n">mask_keep</span> <span class="o">=</span> <span class="n">m</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">Ww</span><span class="p">]</span>
            <span class="n">mask_vis</span> <span class="o">=</span> <span class="n">mask_keep</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">masked_person</span> <span class="o">=</span> <span class="n">person</span> <span class="o">*</span> <span class="n">mask_keep</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_cpu32</span><span class="p">(</span><span class="n">t</span><span class="p">):</span> 
                <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

            <span class="c1"># 타일 구성</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Composing visualization tiles&quot;</span><span class="p">)</span>
            <span class="n">tiles_and_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">_cpu32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_denorm</span><span class="p">(</span><span class="n">person</span><span class="p">)),</span> <span class="s2">&quot;person&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">_cpu32</span><span class="p">(</span><span class="n">mask_vis</span><span class="p">),</span> <span class="s2">&quot;mask&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">_cpu32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_denorm</span><span class="p">(</span><span class="n">masked_person</span><span class="p">)),</span> <span class="s2">&quot;masked&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">_cpu32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_denorm</span><span class="p">(</span><span class="n">garment</span><span class="p">)),</span> <span class="s2">&quot;garment&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">xi_noisy_img</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;noisy(t=</span><span class="si">{</span><span class="n">t0</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">_cpu32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_denorm</span><span class="p">(</span><span class="n">x_gt</span><span class="p">)),</span> <span class="s2">&quot;GT&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">preview_from_input</span><span class="p">,</span> <span class="s2">&quot;pred(input)&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">preview_from_gt</span><span class="p">,</span> <span class="s2">&quot;pred(GT)&quot;</span><span class="p">),</span>
            <span class="p">]</span>

            <span class="c1"># 그리드 생성</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating image grid&quot;</span><span class="p">)</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tiles_and_names</span><span class="p">]</span>
            <span class="n">panel_bchw</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">col_widths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tiles_and_names</span><span class="p">]</span>
            <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tiles_and_names</span><span class="p">]</span>

            <span class="n">grid</span> <span class="o">=</span> <span class="n">make_grid</span><span class="p">(</span><span class="n">panel_bchw</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># 캡션 추가</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding captions&quot;</span><span class="p">)</span>
            <span class="c1"># 2) 캡션 생성</span>
            <span class="n">caption_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preview_caption_h&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
            <span class="n">bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bottom_caption_row</span><span class="p">(</span>
                <span class="n">col_names</span><span class="p">,</span> <span class="n">col_widths</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">caption_h</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="mf">0.1</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># (3, Hc, Wb)</span>

            <span class="c1"># 3) 혹시 모를 폭 불일치를 안전하게 보정</span>
            <span class="n">Wg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">Wb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bottom</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">Wb</span> <span class="o">!=</span> <span class="n">Wg</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Wb</span> <span class="o">&lt;</span> <span class="n">Wg</span><span class="p">:</span>
                    <span class="n">pad_left</span>  <span class="o">=</span> <span class="p">(</span><span class="n">Wg</span> <span class="o">-</span> <span class="n">Wb</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="n">pad_right</span> <span class="o">=</span> <span class="n">Wg</span> <span class="o">-</span> <span class="n">Wb</span> <span class="o">-</span> <span class="n">pad_left</span>
                    <span class="n">bottom</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">bottom</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">pad_left</span><span class="p">,</span> <span class="n">pad_right</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bottom</span> <span class="o">=</span> <span class="n">bottom</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">Wg</span><span class="p">]</span>

            <span class="c1"># 4) 세로 방향으로 붙임 (C, H_sum, W)</span>
            <span class="n">final_img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">grid</span><span class="p">,</span> <span class="n">bottom</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># 저장</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving final image&quot;</span><span class="p">)</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;step_</span><span class="si">{</span><span class="n">global_step</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
            
            <span class="c1"># 디렉토리 존재 확인</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">save_image</span><span class="p">(</span><span class="n">final_img</span><span class="p">,</span> <span class="n">out_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Enhanced preview saved successfully: </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✗ Preview generation failed at step </span><span class="si">{</span><span class="n">global_step</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Traceback: </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>  <span class="c1"># 디버깅을 위해 예외 재발생</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># GPU 메모리 정리</span>
            <span class="k">if</span> <span class="s1">&#39;Xi_lat&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">Xi_lat</span>
            <span class="k">if</span> <span class="s1">&#39;z0_lat&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">z0_lat</span>
            <span class="k">if</span> <span class="s1">&#39;shared_noise&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">shared_noise</span>
            <span class="k">if</span> <span class="s1">&#39;x_in&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">x_in</span>
            <span class="k">if</span> <span class="s1">&#39;x_gt&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">x_gt</span>
            <span class="k">if</span> <span class="s1">&#39;m&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">m</span>
            <span class="k">if</span> <span class="s1">&#39;person&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">person</span><span class="p">,</span> <span class="n">garment</span><span class="p">,</span> <span class="n">mask_keep</span><span class="p">,</span> <span class="n">mask_vis</span><span class="p">,</span> <span class="n">masked_person</span>
            
            <span class="c1"># GPU 캐시 정리</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;GPU memory cleaned after preview generation&quot;</span><span class="p">)</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_bottom_caption_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">widths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                            <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                            <span class="n">bg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">fg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;캡션 행 생성&quot;&quot;&quot;</span>
        <span class="n">W_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">widths</span><span class="p">)))</span>
        <span class="n">H</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">bg255</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bg</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span>
        <span class="n">fg255</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fg</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">W_total</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span> <span class="p">(</span><span class="n">bg255</span><span class="p">,</span> <span class="n">bg255</span><span class="p">,</span> <span class="n">bg255</span><span class="p">))</span>
        <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="s2">&quot;DejaVuSans.ttf&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">load_default</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> 
                <span class="n">font</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">widths</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bbox</span> <span class="o">=</span> <span class="n">draw</span><span class="o">.</span><span class="n">textbbox</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
                <span class="n">tw</span><span class="p">,</span> <span class="n">th</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">tw</span><span class="p">,</span> <span class="n">th</span> <span class="o">=</span> <span class="n">draw</span><span class="o">.</span><span class="n">textsize</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="n">tw</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="n">th</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="n">fg255</span><span class="p">,</span> <span class="n">fg255</span><span class="p">,</span> <span class="n">fg255</span><span class="p">),</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">+=</span> <span class="n">w</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="mf">255.0</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="EnhancedCatVTON_SD3_Trainer.enhanced_step">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.EnhancedCatVTON_SD3_Trainer.enhanced_step">[문서]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">enhanced_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;향상된 학습 스텝 - 더 안정적인 loss 계산&quot;&quot;&quot;</span>
        <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">size_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">size_w</span>

        <span class="n">x_concat_in</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;x_concat_in&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">x_concat_gt</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;x_concat_gt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">m_concat</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;m_concat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="c1"># VAE 인코딩</span>
            <span class="n">z0</span> <span class="o">=</span> <span class="n">to_latent_sd3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">,</span> <span class="n">x_concat_gt</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># target</span>
            <span class="n">Xi</span> <span class="o">=</span> <span class="n">to_latent_sd3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">,</span> <span class="n">x_concat_in</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># input</span>

            <span class="c1"># 마스크를 latent 해상도로 변환</span>
            <span class="n">Mi</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="n">m_concat</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">H</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">W</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span><span class="p">),</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="n">bsz</span> <span class="o">=</span> <span class="n">z0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># 향상된 timestep 샘플링</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">compute_density_for_timestep_sampling</span><span class="p">(</span>
            <span class="n">weighting_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">weighting_scheme</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">bsz</span><span class="p">,</span>
            <span class="n">logit_mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">logit_mean</span><span class="p">,</span>
            <span class="n">logit_std</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">logit_std</span><span class="p">,</span>
            <span class="n">mode_scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">mode_scale</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="c1"># 스케줄러에서 timesteps 가져오기</span>
        <span class="n">scheduler</span><span class="p">,</span> <span class="n">timesteps_all</span> <span class="o">=</span> <span class="n">setup_enhanced_timesteps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_scheduler</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mu</span><span class="p">)</span>
        <span class="n">num_tt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timesteps_all</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">num_tt</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_tt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">timesteps</span> <span class="o">=</span> <span class="n">timesteps_all</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">z0</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># 로깅 (첫 스텝에만)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span> <span class="ow">and</span> <span class="n">global_step</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enhanced timesteps range: [</span><span class="si">{</span><span class="n">timesteps_all</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">timesteps_all</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample timesteps: </span><span class="si">{</span><span class="n">timesteps</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 일관된 노이즈 주입 - 스케줄러 API 우선</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_scheduler_for_scale</span> <span class="o">=</span> <span class="n">scheduler</span>
        <span class="n">z0_noisy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_noise_with_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>
        <span class="n">Xi_noisy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_noise_with_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>

        <span class="c1"># 인페인팅 입력 구성 (KEEP 영역은 입력, HOLE 영역은 타겟 기반)</span>
        <span class="n">noisy_model_input</span> <span class="o">=</span> <span class="n">Mi</span> <span class="o">*</span> <span class="n">Xi_noisy</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Mi</span><span class="p">)</span> <span class="o">*</span> <span class="n">z0_noisy</span>

        <span class="c1"># 모델 입력 스케일링</span>
        <span class="n">hs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhanced_noise_schedule</span><span class="p">(</span><span class="n">noisy_model_input</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)</span>

        <span class="c1"># 프롬프트 임베딩</span>
        <span class="n">prompt_embeds</span><span class="p">,</span> <span class="n">pooled_prompt_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_prompts</span><span class="p">(</span><span class="n">bsz</span><span class="p">)</span>

        <span class="c1"># 모델 추론</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">)):</span>
            <span class="n">model_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">(</span>
                <span class="n">hidden_states</span><span class="o">=</span><span class="n">hs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                <span class="n">timestep</span><span class="o">=</span><span class="n">timesteps</span><span class="p">,</span>
                <span class="n">encoder_hidden_states</span><span class="o">=</span><span class="n">prompt_embeds</span><span class="p">,</span>
                <span class="n">pooled_projections</span><span class="o">=</span><span class="n">pooled_prompt_embeds</span><span class="p">,</span>
                <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="c1"># inference.py와 동일한 공식 사용</span>
        <span class="n">pred_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_scheduler</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;prediction_type&quot;</span><span class="p">,</span> <span class="s2">&quot;epsilon&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">pred_type</span> <span class="o">==</span> <span class="s2">&quot;epsilon&quot;</span><span class="p">:</span>
            <span class="c1"># epsilon prediction: z_0 = z_t - σ * ε </span>
            <span class="c1"># sigma는 정규화된 timestep 사용 (0-1 범위)</span>
            <span class="n">sigma4</span> <span class="o">=</span> <span class="p">(</span><span class="n">timesteps</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>
            <span class="n">x0_pred</span> <span class="o">=</span> <span class="n">noisy_model_input</span> <span class="o">-</span> <span class="n">sigma4</span> <span class="o">*</span> <span class="n">model_output</span>
        <span class="k">elif</span> <span class="n">pred_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
            <span class="c1"># direct x0 prediction</span>
            <span class="n">x0_pred</span> <span class="o">=</span> <span class="n">model_output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># v_prediction (미지원)</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;v_prediction not supported, got </span><span class="si">{</span><span class="n">pred_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 손실 계산 - HOLE 영역만 고려</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;loss_sigma_weight&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1"># SD3.5 공식 가중치 사용            </span>
            <span class="n">weighting</span> <span class="o">=</span> <span class="n">compute_loss_weighting_for_sd3</span><span class="p">(</span>
                <span class="n">weighting_scheme</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">weighting_scheme</span><span class="p">,</span> 
                <span class="n">sigmas</span><span class="o">=</span><span class="n">timesteps</span> <span class="o">/</span> <span class="mf">1000.0</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weighting</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">timesteps</span><span class="p">)</span>

        <span class="n">target</span> <span class="o">=</span> <span class="n">z0</span>  <span class="c1"># GT latent</span>
        
        <span class="c1"># CatVTON 방식: 전체 이미지 loss + 영역별 가중치</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;use_weighted_loss&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1"># 영역별 가중치 맵 생성</span>
            <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W_total</span> <span class="o">=</span> <span class="n">x0_pred</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">W_half</span> <span class="o">=</span> <span class="n">W_total</span> <span class="o">//</span> <span class="mi">2</span>
            
            <span class="n">left_weight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;left_weight&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
            <span class="n">right_weight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;right_weight&quot;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>
            
            <span class="n">weight_map</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x0_pred</span><span class="p">)</span>
            <span class="n">weight_map</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">W_half</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_weight</span>   <span class="c1"># 왼쪽 사람 영역</span>
            <span class="n">weight_map</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">W_half</span><span class="p">:]</span> <span class="o">=</span> <span class="n">right_weight</span>  <span class="c1"># 오른쪽 의상 영역</span>
            
            <span class="c1"># 가중치 적용된 loss</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">x0_pred</span> <span class="o">-</span> <span class="n">target</span>
            <span class="n">diff_weighted</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">weight_map</span>
            <span class="n">loss_per_sample</span> <span class="o">=</span> <span class="n">weighting</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">diff_weighted</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            
            <span class="c1"># 정규화 (배치 평균)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_per_sample</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 기존 HOLE 방식 (호환성)</span>
            <span class="n">Hmask</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Mi</span><span class="p">)</span>  <span class="c1"># HOLE mask (Mi=1 KEEP, Mi=0 HOLE)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">x0_pred</span> <span class="o">-</span> <span class="n">target</span>
            <span class="n">diff_masked</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">Hmask</span>
            
            <span class="n">B</span> <span class="o">=</span> <span class="n">diff_masked</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loss_per_sample</span> <span class="o">=</span> <span class="n">weighting</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">diff_masked</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">hole_pixels</span> <span class="o">=</span> <span class="n">Hmask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">loss_normalized</span> <span class="o">=</span> <span class="n">loss_per_sample</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">hole_pixels</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_normalized</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># 디버그 정보 (loss 방식에 따라 다르게 계산)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;use_weighted_loss&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1"># CatVTON 방식 디버그 정보</span>
            <span class="n">dbg</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;t_min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">timesteps</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                <span class="s2">&quot;t_max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">timesteps</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                <span class="s2">&quot;w_mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">weighting</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
                <span class="s2">&quot;mse_raw&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">((</span><span class="n">diff</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
                <span class="s2">&quot;target_var&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">var</span><span class="p">()),</span>
                <span class="s2">&quot;pred_var&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x0_pred</span><span class="o">.</span><span class="n">var</span><span class="p">()),</span>
                <span class="s2">&quot;left_ratio&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;left_weight&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
                <span class="s2">&quot;right_ratio&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;right_weight&quot;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)),</span>
                <span class="s2">&quot;model_out_min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">model_output</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                <span class="s2">&quot;model_out_max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">model_output</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                <span class="s2">&quot;x0_pred_min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x0_pred</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                <span class="s2">&quot;x0_pred_max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x0_pred</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                <span class="s2">&quot;target_min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                <span class="s2">&quot;target_max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                <span class="s2">&quot;loss_type&quot;</span><span class="p">:</span> <span class="s2">&quot;weighted_full&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pred_type&quot;</span><span class="p">:</span> <span class="n">pred_type</span><span class="p">,</span>  <span class="c1"># pred_type 추가</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 기존 HOLE 방식 디버그 정보</span>
            <span class="n">Hmask</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Mi</span><span class="p">)</span>  <span class="c1"># HOLE mask 정의</span>
            <span class="n">dbg</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;t_min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">timesteps</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                <span class="s2">&quot;t_max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">timesteps</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                <span class="s2">&quot;w_mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">weighting</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
                <span class="s2">&quot;mse_raw&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(((</span><span class="n">diff</span> <span class="o">*</span> <span class="n">Hmask</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
                <span class="s2">&quot;target_var&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">var</span><span class="p">()),</span>
                <span class="s2">&quot;pred_var&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x0_pred</span><span class="o">.</span><span class="n">var</span><span class="p">()),</span>
                <span class="s2">&quot;hole_ratio&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">Hmask</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
                <span class="s2">&quot;model_out_min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">model_output</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                <span class="s2">&quot;model_out_max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">model_output</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                <span class="s2">&quot;x0_pred_min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x0_pred</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                <span class="s2">&quot;x0_pred_max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x0_pred</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                <span class="s2">&quot;target_min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                <span class="s2">&quot;target_max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                <span class="s2">&quot;loss_type&quot;</span><span class="p">:</span> <span class="s2">&quot;hole_only&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pred_type&quot;</span><span class="p">:</span> <span class="n">pred_type</span><span class="p">,</span>  <span class="c1"># pred_type 추가</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">loss</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">dbg</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_save_ckpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">train_loss_epoch</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">global_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">ckpt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;enhanced_epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">_loss_</span><span class="si">{</span><span class="n">train_loss_epoch</span><span class="si">:</span><span class="s2">.04f</span><span class="si">}</span><span class="s2">.ckpt&quot;</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;transformer&quot;</span><span class="p">:</span> <span class="n">ddp_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">),</span>
            <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;scaler&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="s2">&quot;cfg&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">),</span>
            <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
            <span class="s2">&quot;global_step&quot;</span><span class="p">:</span> <span class="n">global_step</span><span class="p">,</span>
            <span class="s2">&quot;train_loss_epoch&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">train_loss_epoch</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enhanced checkpoint saved: </span><span class="si">{</span><span class="n">ckpt_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ckpt_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resume_from_ckpt_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resume_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">resume_path</span><span class="p">):</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resuming from checkpoint: </span><span class="si">{</span><span class="n">resume_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">ckpt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resume_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">missing</span><span class="p">,</span> <span class="n">unexpected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">ckpt</span><span class="p">[</span><span class="s2">&quot;transformer&quot;</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span> <span class="ow">and</span> <span class="p">(</span><span class="n">missing</span> <span class="ow">or</span> <span class="n">unexpected</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resume - missing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">, unexpected: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unexpected</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load transformer state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ckpt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ckpt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;global_step&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="s2">&quot;optimizer&quot;</span> <span class="ow">in</span> <span class="n">ckpt</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">ckpt</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">])</span>
                <span class="c1"># GPU로 옮기기</span>
                <span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>
                <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                            <span class="n">state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load optimizer state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s2">&quot;scaler&quot;</span> <span class="ow">in</span> <span class="n">ckpt</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_scaler</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">ckpt</span><span class="p">[</span><span class="s2">&quot;scaler&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load scaler state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resumed from epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_epoch</span><span class="si">}</span><span class="s2">, step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="EnhancedCatVTON_SD3_Trainer.train">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.EnhancedCatVTON_SD3_Trainer.train">[문서]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;향상된 학습 루프&quot;&quot;&quot;</span>
        <span class="n">global_step</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;start_step&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;start_epoch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

        <span class="n">data_iter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">max_steps</span><span class="p">,</span>
            <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Enhanced Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">()),</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">global_step</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dist</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">global_step</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">max_steps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">loss_accum</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1"># CatVTON 방식에 맞는 디버그 정보 초기화</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;use_weighted_loss&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">dbg_acc</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;t_min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;t_max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;w_mean&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;mse_raw&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;target_var&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;pred_var&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;left_ratio&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;right_ratio&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;model_out_min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;model_out_max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;x0_pred_min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;x0_pred_max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;target_min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;target_max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> 
                    <span class="s2">&quot;loss_type&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;pred_type&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dbg_acc</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;t_min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;t_max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;w_mean&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;mse_raw&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;target_var&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;pred_var&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;hole_ratio&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;model_out_min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;model_out_max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;x0_pred_min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;x0_pred_max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;target_min&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;target_max&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;loss_type&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
                <span class="p">}</span>
            
            <span class="n">valid_steps</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Gradient accumulation</span>
            <span class="k">for</span> <span class="n">micro_step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">grad_accum</span><span class="p">):</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">data_iter</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enhanced_step</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">global_step</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span> <span class="ow">and</span> <span class="n">global_step</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">global_step</span><span class="si">}</span><span class="s2">: invalid loss in micro_step </span><span class="si">{</span><span class="n">micro_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">loss</span><span class="p">,</span> <span class="n">dbg</span> <span class="o">=</span> <span class="n">out</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">loss</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">loss</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span> <span class="ow">and</span> <span class="n">global_step</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">global_step</span><span class="si">}</span><span class="s2">: non-finite loss=</span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Normalize loss by grad_accum</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">grad_accum</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_scaler</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

                <span class="n">loss_accum</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">grad_accum</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dbg_acc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pred_type&quot;</span><span class="p">,</span> <span class="s2">&quot;loss_type&quot;</span><span class="p">]:</span>
                        <span class="n">dbg_acc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>  <span class="c1"># 문자열은 마지막 값으로 덮어쓰기</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dbg_acc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dbg</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">valid_steps</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">valid_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">global_step</span><span class="si">}</span><span class="s2">: no valid micro-steps&quot;</span><span class="p">)</span>
                <span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span> 
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Gradient clipping and optimizer step</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_scaler</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">unscale_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span>
                <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">],</span> 
                <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_scaler</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span> 
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Loss tracking</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_loss_sum</span> <span class="o">+=</span> <span class="n">loss_accum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_loss_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">train_loss_avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_loss_sum</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_loss_count</span><span class="p">)</span>

            <span class="c1"># Debug info averaging</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dbg_acc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pred_type&quot;</span><span class="p">,</span> <span class="s2">&quot;loss_type&quot;</span><span class="p">]:</span>  <span class="c1"># 문자열은 평균 계산 제외</span>
                    <span class="n">dbg_acc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">valid_steps</span><span class="p">)</span>

            <span class="c1"># Logging</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span> <span class="ow">and</span> <span class="p">((</span><span class="n">global_step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">log_every</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">global_step</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s2">&quot;train/loss_total&quot;</span><span class="p">,</span> <span class="n">train_loss_avg</span><span class="p">,</span> <span class="n">global_step</span><span class="p">)</span>
                
                <span class="c1"># 더 자세한 로깅</span>
                <span class="n">prog</span> <span class="o">=</span> <span class="p">(</span><span class="n">global_step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="n">pct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prog</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Enhanced Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">% | step </span><span class="si">{</span><span class="n">global_step</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">max_steps</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;| loss=</span><span class="si">{</span><span class="n">train_loss_avg</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;| t_range=[</span><span class="si">{</span><span class="n">dbg_acc</span><span class="p">[</span><span class="s1">&#39;t_min&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">dbg_acc</span><span class="p">[</span><span class="s1">&#39;t_max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">] &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;| mse=</span><span class="si">{</span><span class="n">dbg_acc</span><span class="p">[</span><span class="s1">&#39;mse_raw&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;| type=</span><span class="si">{</span><span class="n">dbg_acc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loss_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;| target_var=</span><span class="si">{</span><span class="n">dbg_acc</span><span class="p">[</span><span class="s1">&#39;target_var&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;| model_out=[</span><span class="si">{</span><span class="n">dbg_acc</span><span class="p">[</span><span class="s1">&#39;model_out_min&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">dbg_acc</span><span class="p">[</span><span class="s1">&#39;model_out_max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">] &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;| x0_pred=[</span><span class="si">{</span><span class="n">dbg_acc</span><span class="p">[</span><span class="s1">&#39;x0_pred_min&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">dbg_acc</span><span class="p">[</span><span class="s1">&#39;x0_pred_max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">] &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;| pred_type=</span><span class="si">{</span><span class="n">dbg_acc</span><span class="p">[</span><span class="s1">&#39;pred_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix_str</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loss=</span><span class="si">{</span><span class="n">train_loss_avg</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            
            <span class="c1"># 추가적인 디버깅을 위한 강제 프리뷰 저장 로직</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span> <span class="ow">and</span> <span class="p">((</span><span class="n">global_step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">image_every</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">global_step</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">batch_vis</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">data_iter</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_enhanced_preview</span><span class="p">(</span><span class="n">batch_vis</span><span class="p">,</span> <span class="n">global_step</span><span class="p">,</span> <span class="n">max_rows</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[img] saved preview at step </span><span class="si">{</span><span class="n">global_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[img] saved preview at step </span><span class="si">{</span><span class="n">global_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[warn] preview save failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


            <span class="c1"># Synchronization</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dist</span><span class="p">:</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>

            <span class="c1"># Epoch 관리</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">global_step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">save_epoch_ckpt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_ckpt</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_loss_avg</span><span class="p">,</span> <span class="n">global_step</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch checkpoint saved: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># 에포크 통계 리셋</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_loss_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_loss_count</span> <span class="o">=</span> <span class="mi">0</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enhanced Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dist</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>

        <span class="c1"># 최종 체크포인트 저장</span>
        <span class="n">final_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_loss_sum</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_loss_count</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_loss_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="n">final_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_ckpt</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">final_loss</span><span class="p">,</span> <span class="n">global_step</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final checkpoint saved: </span><span class="si">{</span><span class="n">final_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_main</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Enhanced training completed successfully&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dist</span><span class="p">:</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span></div>
</div>



<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># Enhanced Config &amp; CLI</span>
<span class="c1"># ------------------------------------------------------------</span>
<span class="n">ENHANCED_DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;list_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;sd3_model&quot;</span><span class="p">:</span> <span class="s2">&quot;stabilityai/stable-diffusion-3.5-large&quot;</span><span class="p">,</span>
    <span class="s2">&quot;size_h&quot;</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s2">&quot;size_w&quot;</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span>
    <span class="s2">&quot;mask_based&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;invert_mask&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>

    <span class="c1"># 향상된 학습 설정</span>
    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">3e-5</span><span class="p">,</span>  <span class="c1"># 더 안정적인 학습률</span>
    <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;grad_accum&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;max_steps&quot;</span><span class="p">:</span> <span class="mi">128000</span><span class="p">,</span>
    <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">1337</span><span class="p">,</span> <span class="s2">&quot;num_workers&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;mixed_precision&quot;</span><span class="p">:</span> <span class="s2">&quot;bf16&quot;</span><span class="p">,</span>  <span class="c1"># bf16 권장 (더 안정적)</span>
    <span class="s2">&quot;use_scaler&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># bf16에서는 스케일러 불필요</span>

    <span class="c1"># 메모리 최적화</span>
    <span class="s2">&quot;prefer_xformers&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;disable_text&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;save_root_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="s2">&quot;save_name&quot;</span><span class="p">:</span> <span class="s2">&quot;enhanced_catvton_sd35&quot;</span><span class="p">,</span>
    <span class="s2">&quot;log_every&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;image_every&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>  <span class="c1"># 더 자주 로깅</span>
    <span class="s2">&quot;save_epoch_ckpt&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># 더 자주 저장</span>
    <span class="s2">&quot;default_resume_ckpt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;resume_ckpt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>

    <span class="c1"># SD3.5 최적화된 학습 파라미터</span>
    <span class="s2">&quot;weighting_scheme&quot;</span><span class="p">:</span> <span class="s2">&quot;logit_normal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;logit_mean&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="s2">&quot;logit_std&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;mode_scale&quot;</span><span class="p">:</span> <span class="mf">1.29</span><span class="p">,</span>
    <span class="s2">&quot;loss_sigma_weight&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>

    <span class="c1"># CatVTON Loss Weighting</span>
    <span class="s2">&quot;use_weighted_loss&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;left_weight&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;right_weight&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="s2">&quot;remove_inpainting&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>

    <span class="c1"># 향상된 프리뷰 설정</span>
    <span class="s2">&quot;preview_infer_steps&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>  <span class="c1"># 더 빠른 프리뷰</span>
    <span class="s2">&quot;preview_seed&quot;</span><span class="p">:</span> <span class="mi">1234</span><span class="p">,</span>
    <span class="s2">&quot;preview_strength&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>  <span class="c1"># 더 강한 디노이징</span>
    <span class="s2">&quot;preview_rows&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;preview_caption_h&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>

    <span class="c1"># 향상된 프롬프트</span>
    <span class="s2">&quot;fixed_prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;high quality, photorealistic, detailed clothing texture, natural lighting, sharp focus&quot;</span><span class="p">,</span>
    <span class="s2">&quot;disable_dynamic_shifting&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>

    <span class="c1"># 런타임</span>
    <span class="s2">&quot;hf_token&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">}</span>

<div class="viewcode-block" id="parse_enhanced_args">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.parse_enhanced_args">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_enhanced_args</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enhanced SD3.5 CatVTON Training&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;configs/claude.yaml&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;YAML config path&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--list_file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Training data list file&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--sd3_model&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;SD3.5 model&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--size_h&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--size_w&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mask_based&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mask_free&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--invert_mask&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--lr&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--batch_size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--grad_accum&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--max_steps&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--log_every&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--image_every&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mixed_precision&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fp16&quot;</span><span class="p">,</span> <span class="s2">&quot;fp32&quot;</span><span class="p">,</span> <span class="s2">&quot;bf16&quot;</span><span class="p">])</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--seed&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--num_workers&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--hf_token&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--disable_text&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--enable_text&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--save_root_dir&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--save_name&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--preview_infer_steps&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--preview_strength&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--preview_seed&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--resume_ckpt&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--weighting_scheme&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                   <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sigma_sqrt&quot;</span><span class="p">,</span><span class="s2">&quot;logit_normal&quot;</span><span class="p">,</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span><span class="s2">&quot;cosmap&quot;</span><span class="p">])</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--logit_mean&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--logit_std&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mode_scale&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fixed_prompt&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--disable_dynamic_shifting&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--enable_dynamic_shifting&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    
    <span class="c1"># CatVTON 가중치 설정</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--use_weighted_loss&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--disable_weighted_loss&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span> 
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--left_weight&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--right_weight&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--remove_inpainting&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--keep_inpainting&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span></div>


<div class="viewcode-block" id="load_enhanced_config">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.load_enhanced_config">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_enhanced_config</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DotDict</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ENHANCED_DEFAULTS</span><span class="p">)</span>

    <span class="c1"># YAML 설정 로드</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">yaml</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;PyYAML required. Install: pip install pyyaml&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">y</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">})</span>

    <span class="c1"># CLI 오버라이드</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="c1"># 불린 플래그 처리</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;mask_free&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;mask_based&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;mask_based&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;mask_based&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;invert_mask&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;invert_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;enable_text&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;disable_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;disable_text&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;disable_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;enable_dynamic_shifting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;disable_dynamic_shifting&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;disable_dynamic_shifting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;disable_dynamic_shifting&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;fixed_prompt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;fixed_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fixed_prompt</span>

    <span class="c1"># CatVTON 가중치 플래그 처리</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;disable_weighted_loss&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;use_weighted_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;use_weighted_loss&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;use_weighted_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;keep_inpainting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;remove_inpainting&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;remove_inpainting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;remove_inpainting&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">DotDict</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span></div>


<div class="viewcode-block" id="build_enhanced_run_dirs">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.build_enhanced_run_dirs">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_enhanced_run_dirs</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">DotDict</span><span class="p">,</span> <span class="n">run_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">run_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">run_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">save_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">save_root_dir</span><span class="p">,</span> <span class="n">run_name</span><span class="p">)</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;run_dir&quot;</span><span class="p">:</span> <span class="n">run_dir</span><span class="p">,</span>
        <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">),</span>
        <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;models&quot;</span><span class="p">),</span>
        <span class="s2">&quot;tb&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;tb&quot;</span><span class="p">),</span>
        <span class="s2">&quot;logs&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">),</span>  <span class="c1"># 추가 로그 디렉토리</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">paths</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">paths</span></div>


<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../claude_sd35_train.html#claude_sd35_train.main">[문서]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_enhanced_args</span><span class="p">()</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">load_enhanced_config</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># 분산 학습 초기화</span>
    <span class="n">dinfo</span> <span class="o">=</span> <span class="n">maybe_init_distributed</span><span class="p">()</span>
    <span class="n">is_dist</span> <span class="o">=</span> <span class="n">dinfo</span><span class="p">[</span><span class="s2">&quot;is_dist&quot;</span><span class="p">]</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">dinfo</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">]</span>
    

    <span class="c1"># 실행 디렉토리 생성</span>
    <span class="n">run_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">run_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">save_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">run_name</span> <span class="o">=</span> <span class="n">bcast_object</span><span class="p">(</span><span class="n">run_name</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">run_dirs</span> <span class="o">=</span> <span class="n">build_enhanced_run_dirs</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enhanced SD3.5 CatVTON Training Script v2.0&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">_try_copy_running_script</span><span class="p">(</span><span class="n">run_dirs</span><span class="p">[</span><span class="s2">&quot;run_dir&quot;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run directory: </span><span class="si">{</span><span class="n">run_dirs</span><span class="p">[</span><span class="s1">&#39;run_dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enhanced training configuration:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Model: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">sd3_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Resolution: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">size_h</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">size_w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Batch size: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> (grad_accum: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">grad_accum</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Learning rate: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">lr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Mixed precision: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">mixed_precision</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Max steps: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">max_steps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Preview every: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">image_every</span><span class="si">}</span><span class="s2"> steps&quot;</span><span class="p">)</span>

    <span class="n">cfg_yaml_to_save</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span> <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># 향상된 트레이너 생성 및 실행</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">EnhancedCatVTON_SD3_Trainer</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">run_dirs</span><span class="p">,</span> <span class="n">cfg_yaml_to_save</span><span class="o">=</span><span class="n">cfg_yaml_to_save</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enhanced training completed successfully!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training interrupted by user&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training failed with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_dist</span><span class="p">:</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">destroy_process_group</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
            
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">CatVTON</a></h1>








<h3>탐색</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../claude_sd35_train.html">claude_sd35_train 모듈</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">모듈 코드</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">빠른 검색</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="이동" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, kjk.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>